{% extends "layout.html" %}

{% block head %}


<script type=text/javascript> $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};</script>

{% endblock head %}

{% block content %}

  <div class="leftSideContainer">
    <h1 class="leftSideHeadline">Help Sort Problems</h1>
    <h3 class="leftSideDescription">On this page you can add skills to problems
    so that other people can find problems easily</h3>
  </div>

  <div id="sortGradientBox" class="rightSideGradientBox">
    <p class="formLabel">Problem</p>
    <p id="sort_problem">{{ problem.question }}</p>

    <p class="formLabel">Answer</p>
    <p id="sort_answer">{{ problem.answer }}</p>

    <p>Skills:</p>

    <ul id="skillsList">
      {% for skill in problem.skills %}
        <li id="sortSkill_{{ skill.id }}">{{ skill.skillName }} <a style="color: blue" href="#" onclick="removeSkill({{ skill.id }}, {{ problem.id }})">remove</a></li>
      {% endfor %}
    </ul>

    <template>
      <li>asdf
      </li>
    </template>

    <input type="text" id="sort_addSkillQuery" oninput="queryEdited()" placeholder="Search For A Skill"></input>
    <button id='btn_add' onclick="addSkill()">Add</button>
    <button id='btn_createSkill' onclick="createSkill()">Create New Skill</button>
    <div id="sort_skillList">
      <h1 id="sort_queryResult"></h1>
    </div>

    <div id="sortButtons">
      <button id='btn_flag' name="button">Flag</button>
      <button id='btn_next' name="button">Next</button>
    </div>
  </div>


  <script type=text/javascript>
    var curProbId = {{ problem.id }};
    var selectedSkillId = 0;

    function displaySkill(name, id) {
      var temp = document.querySelector('template').content;
      var li = temp.querySelector('li');
      var text_to_change = li.childNodes[0];
      text_to_change.nodeValue = name;
      li.id = "sortSkill_" + id;
      if (li.childNodes[1] != undefined) {
        li.removeChild(li.childNodes[1])
      }
      var a = document.createElement("a");
      a.innerHTML = '<a style="color: blue" href="#" onclick="removeSkill(' + id.toString() + ', ' + curProbId.toString() + ')"> remove</a>';
      li.appendChild(a);
      document.querySelector('#skillsList').appendChild(document.importNode(temp, true));
    }

    $(function() {
      $('button#btn_flag').bind('click', function() {
        $.getJSON($SCRIPT_ROOT + '/db/_flag_problem', {
          //nada
        }, function(data) {
          //nope
        });
        return false;
      });
    });

    $(function() {
      $('button#btn_next').bind('click', function() {
        $.getJSON($SCRIPT_ROOT + '/db/sort/_next_problem', {
          //zip
        }, function(data) {
          console.log(data)
           document.getElementById("sort_problem").innerHTML = data.problem;
           document.getElementById("sort_answer").innerHTML = data.answer;
           curProbId = data.id;

           //Clear skills and add new ones
           document.getElementById("skillsList").innerHTML = "";
           skills = data.skills
           console.log(skills)
           console.log(data.skills[0].skillName)
           skillsLen = Object.keys(data.skills).length
           //console.log("Length is: " + Object.keys(data.skills).length)
           for (i = 0; i < skillsLen; i++) {
             displaySkill(data.skills[i].skillName, data.skills[i].skillId);
           }
        });
        return false;
      });
    });

    function removeSkill(skillId, probId) {
      console.log("remove began")
      $.getJSON($SCRIPT_ROOT + '/db/_remove_skill', {
        skillId: skillId,
        probId: probId,
      }, function(data) {
      });
      skillListItem= document.getElementById("sortSkill_" + skillId.toString())
      skillListItem.parentNode.removeChild(skillListItem);
      console.log("Skill Removed");
    }

    function addSkill() {
      console.log(selectedSkillId + " added")
      if ({{ problem.id }} != undefined ) {
        probId = {{ problem.id }}
      } else {
        console.log("no skill selected")
      }
      $.getJSON($SCRIPT_ROOT + '/db/_add_skill', {
        probId: probId,
        skillId: selectedSkillId,
      }, function(data) {
        displaySkill(data.name, data.id);
        console.log("yep");
      });
    }

    function createSkill() {
      $.getJSON($SCRIPT_ROOT + '/db/_create_skill', {
        skillName: document.querySelector('#sort_addSkillQuery').value,
      }, function(data) {
        selectedSkillId = data.id;
        addSkill()
      });
    }

    function queryEdited() {
      const queryBox = document.querySelector('#sort_addSkillQuery');
      console.log("Query is: " + queryBox.value)
      query = queryBox.value
      $.getJSON($SCRIPT_ROOT + '/db/_get_skill_query', {
        query: query,
      }, function(data) {
        console.log(data.returnSkills);
        queryResults = data.returnSkills;
          document.getElementById('sort_queryResult').innerHTML = (queryResults[0].name)
          selectedSkillId = queryResults[0].id;
          console.log(selectedSkillId)
      });
    }
  </script>
{% endblock content %}
