{% extends "layout.html" %}

{% block head %}


<script type=text/javascript> $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};</script>

{% endblock head %}

{% block content %}

  <div class="leftSideContainer">
    <h1 class="leftSideHeadline">Help Sort Problems</h1>
    <h3 class="leftSideDescription">On this page you can add skills to problems
    so that other people can find problems easily</h3>
  </div>

  <div id="sortGradientBox" class="rightSideGradientBox">
    <p class="formLabel">Problem</p>
    <p>{{ problem.question }}</p>

    <p class="formLabel">Answer</p>
    <p>{{ problem.answer }}</p>

    <p>Skills:</p>

    <ul id="skillsList">
      {% for skill in problem.skills %}
        <li id="sortSkill_{{ skill.id }}">{{ skill.skillName }} <a style="color: blue" href="#" onclick="removeSkill({{ skill.id }}, {{ problem.id }})">remove</a></li>
      {% endfor %}
      <template>
        <li>asdf
        </li>
      </template>
    </ul>

    <input type="text" id="sort_addSkillQuery" oninput="queryEdited()" placeholder="Search For A Skill"></input>
    <button id='btn_add' onclick="addSkill()">Add</button>
    <button id='btn_add' onclick="addSkill()">Create New Skill</button>
    <div id="sort_skillList">
      <h1 id="sort_queryResult"></h1>
    </div>

    <div id="sortButtons">
      <button id='btn_flag' name="button">Flag</button>
      <button id='btn_submit' type="submit" name="button">Submit</button>
      <button id='btn_skip' name="button">Skip</button>
    </div>
  </div>


  <script type=text/javascript>
    var curProbId = {{ problem.id }};
    function displaySkill(name, id) {
      console.log("started");

      var temp = document.querySelector('template').content;
      // Update something in the template DOM.

      var li = temp.querySelector('li');
      var text_to_change = li.childNodes[0];
      text_to_change.nodeValue = name;
      li.id = "sortSkill_" + id;
      if (li.childNodes[1] != undefined) {
        li.removeChild(li.childNodes[1])
      }
      var a = document.createElement("a");
      a.innerHTML = '<a style="color: blue" href="#" onclick="removeSkill(' + id.toString() + ', ' + curProbId.toString() + ')"> remove</a>';
      li.appendChild(a);
      document.querySelector('#skillsList').appendChild(document.importNode(temp, true));

    }

    var selectedSkillId = 0;
    $(function() {
      $('button#btn_submit').bind('click', function() {
        console.log("activated")
        $.getJSON($SCRIPT_ROOT + '/db/sort/_submit_sort', {
          //nothing yet
        }, function(data) {
          //nothing yet
        });
        return false;
      });
    });

    $(function() {
      $('button#btn_flag').bind('click', function() {
        console.log("activated")
        $.getJSON($SCRIPT_ROOT + '/db/_flag_problem', {
          //nada
        }, function(data) {
          //nope
        });
        return false;
      });
    });

    $(function() {
      $('button#btn_skip').bind('click', function() {
        console.log("activated")
        $.getJSON($SCRIPT_ROOT + '/db/_skip_problem', {
          //zip
        }, function(data) {
          //zada
        });
        return false;
      });
    });

    function removeSkill(skillId, probId) {
      console.log("remove began")
      $.getJSON($SCRIPT_ROOT + '/db/_remove_skill', {
        skillId: skillId,
        probId: probId,
      }, function(data) {
      });
      skillListItem= document.getElementById("sortSkill_" + skillId.toString())
      skillListItem.parentNode.removeChild(skillListItem);
      console.log("Skill Removed");
    }

    function addSkill() {
      console.log(selectedSkillId + " added")
      if ({{ problem.id }} != undefined ) {
        probId = {{ problem.id }}
      } else {
        console.log("huh")
      }
      $.getJSON($SCRIPT_ROOT + '/db/_add_skill', {
        probId: probId,
        skillId: selectedSkillId,
      }, function(data) {
        displaySkill(data.name, data.id);
        console.log("yep");
      });


    }
    function queryEdited() {
      const queryBox = document.querySelector('#sort_addSkillQuery');
      console.log("Query is: " + queryBox.value)
      query = queryBox.value
      $.getJSON($SCRIPT_ROOT + '/db/_get_skill_query', {
        query: query,
      }, function(data) {
        console.log(data.returnSkills);
        queryResults = data.returnSkills;
          document.getElementById('sort_queryResult').innerHTML = (queryResults[0].name)
          selectedSkillId = queryResults[0].id;
          console.log(selectedSkillId)
      });
    }
  </script>
{% endblock content %}
